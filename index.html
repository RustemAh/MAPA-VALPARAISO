<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ganador presidencial por comuna — Región de Valparaíso</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
:root { color-scheme: light; }
* { box-sizing:border-box; }

body {
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#f3f4f6;
  color:#111827;
}

.wrap {
  max-width:1080px;
  margin:0 auto;
  padding:16px;
}

/* Header */
.header {
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  gap:8px;
  align-items:flex-end;
  margin-bottom:12px;
}
.header-main {
  display:flex;
  flex-direction:column;
  gap:4px;
}
.header-title {
  margin:0;
  font-size:22px;
  font-weight:900;
}
.header-sub {
  margin:0;
  font-size:12px;
  color:#6b7280;
}
.badge-main {
  background:#FFD400;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  text-transform:uppercase;
}

/* Layout */
.layout {
  display:grid;
  grid-template-columns:minmax(0,3fr) minmax(260px,1.2fr);
  gap:16px;
}
@media (max-width:840px) {
  .layout { grid-template-columns:1fr; }
}

/* Map card */
.map-card {
  background:#fff;
  border-radius:14px;
  border:1px solid #e5e7eb;
  box-shadow:0 1px 3px rgba(15,23,42,.08);
  padding:14px 16px 12px;
}
.map-card h2 {
  margin:0 0 4px;
  font-size:16px;
  font-weight:800;
}
.map-sub {
  margin:0 0 10px;
  font-size:12px;
  color:#6b7280;
}

#map {
  width:100%;
  height:520px;
  border-radius:12px;
  overflow:hidden;
}

/* Legend */
.legend {
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:11px;
}
.legend-item {
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.legend-swatch {
  width:14px;
  height:14px;
  border-radius:4px;
  border:1px solid rgba(15,23,42,.2);
}

/* Side panel */
.side {
  background:#fff;
  border-radius:14px;
  border:1px solid #e5e7eb;
  box-shadow:0 1px 3px rgba(15,23,42,.08);
  padding:14px 16px 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.side h3 {
  margin:0;
  font-size:15px;
  font-weight:800;
}
.side-sub {
  font-size:11px;
  color:#6b7280;
}

/* Candidatos */
.cand-list {
  margin:6px 0 4px;
  padding:0;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.cand-item {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  font-size:12px;
}
.cand-main {
  display:flex;
  align-items:center;
  gap:6px;
}
.cand-dot {
  width:10px;
  height:10px;
  border-radius:50%;
}
.cand-name { font-weight:700; }
.cand-party { color:#6b7280; font-size:11px; }
.cand-perc { font-weight:700; }

/* Commune info */
.comuna-info {
  margin-top:6px;
  padding-top:6px;
  border-top:1px solid #e5e7eb;
  font-size:12px;
}
.comuna-name {
  font-weight:800;
  margin-bottom:2px;
}
.comuna-line { color:#4b5563; }

/* Footer */
.footer {
  margin-top:10px;
  font-size:11px;
  color:#6b7280;
  display:flex;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
}

/* Leaflet tooltip NBC style */
.leaflet-tooltip {
  background:#111827;
  color:#f9fafb;
  border:none;
  border-radius:6px;
  box-shadow:0 4px 10px rgba(15,23,42,.35);
  padding:6px 8px;
  font-size:11px;
}
.leaflet-tooltip-top:before {
  border-top-color:#111827;
}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="header-main">
      <h1 class="header-title">Ganador presidencial por comuna — Región de Valparaíso</h1>
      <p class="header-sub">
        Mapa estilo NBC · datos cargados desde Google Sheets (votos por comuna, ganador calculado automáticamente).
      </p>
    </div>
    <div class="badge-main">Mapa interactivo · NBC/Epicentro</div>
  </header>

  <section class="layout">
    <article class="map-card">
      <h2>Mapa comunal</h2>
      <p class="map-sub">Pasa el mouse o toca una comuna para ver quién gana en esa zona, según los votos cargados.</p>
      <div id="map"></div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-swatch" style="background:#005CA9;"></span>
          <span>Bloque centroizquierda</span>
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:#E5252A;"></span>
          <span>Bloque derecha</span>
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:#F59E0B;"></span>
          <span>Terceros / independientes</span>
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:#6b7280;"></span>
          <span>Sin datos / empate</span>
        </div>
      </div>
    </article>

    <aside class="side">
      <div>
        <h3>Candidatos presidenciales (definidos en el código)</h3>
        <p class="side-sub">Se usan para colorear el mapa y mostrar info por comuna.</p>
      </div>

      <ul class="cand-list" id="candList"></ul>

      <div class="comuna-info" id="comunaInfo">
        <div class="comuna-name">Seleccione una comuna</div>
        <div class="comuna-line">
          Pasa el cursor por el mapa para ver el candidato ganador en cada comuna.
        </div>
      </div>
    </aside>
  </section>

  <footer class="footer">
    <div>Epicentro Labs · Mapa NBC Valparaíso</div>
    <div id="timestamp">—</div>
  </footer>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
// =====================
// CONFIGURACIÓN BASE
// =====================

// URL CSV de tu Google Sheets (gid=0)
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/1MxCd4GCNJ8bAmf8Fa4LlpOLsvkxAxJt2av6gLT4acRs/export?format=csv&gid=0";

// Mapa de candidatos: clave = NOMBRE DE COLUMNA EXACTO en tu Sheet
const candidateMeta = {
  "Franco Parisi": {
    short: "Parisi",
    bloc: "Terceros",
    color: "#F59E0B"
  },
  "Jeanete Jara": {
    short: "Jara",
    bloc: "Centroizquierda",
    color: "#005CA9"
  },
  "Marco Enríquez Ominami": {
    short: "M. Enríquez-O.",
    bloc: "Centroizquierda",
    color: "#0EA5E9"
  },
  "Johannes Kaiser": {
    short: "Kaiser",
    bloc: "Derecha",
    color: "#111827"
  },
  "José Antonio Kast": {
    short: "Kast",
    bloc: "Derecha",
    color: "#E5252A"
  },
  "Eduardo Artes": {
    short: "Artés",
    bloc: "Izquierda",
    color: "#A21CAF"
  },
  "Evelyn Matthei": {
    short: "Matthei",
    bloc: "Derecha",
    color: "#B91C1C"
  },
  "Harold Mayne-Nicholls": {
    short: "Mayne-N.",
    bloc: "Independiente",
    color: "#22C55E"
  }
};

// =====================
// HELPERS
// =====================
function toIntVotes(v) {
  if (v == null) return 0;
  const n = parseInt(String(v).replace(/[^\d-]/g, ""), 10);
  return isNaN(n) ? 0 : n;
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  if (!lines.length) return { headers: [], rows: [] };
  const headers = lines[0].split(",").map(h => h.trim());
  const rows = lines.slice(1).map(line => {
    const cols = line.split(",");
    const obj = {};
    headers.forEach((h, i) => {
      obj[h] = (cols[i] || "").trim();
    });
    return obj;
  });
  return { headers, rows };
}

// =====================
// PANEL LATERAL
// =====================
function renderCandidateList() {
  const ul = document.getElementById("candList");
  ul.innerHTML = "";
  Object.entries(candidateMeta).forEach(([fullName, meta]) => {
    const li = document.createElement("li");
    li.className = "cand-item";
    li.innerHTML = `
      <div class="cand-main">
        <span class="cand-dot" style="background:${meta.color};"></span>
        <div>
          <div class="cand-name">${fullName}</div>
          <div class="cand-party">${meta.bloc}</div>
        </div>
      </div>
      <div class="cand-perc">—</div>
    `;
    ul.appendChild(li);
  });
}

function updateComunaInfo(name, data, row) {
  const box = document.getElementById("comunaInfo");
  if (!name) {
    box.innerHTML = `
      <div class="comuna-name">Seleccione una comuna</div>
      <div class="comuna-line">
        Pasa el cursor por el mapa para ver el candidato ganador en cada comuna.
      </div>
    `;
    return;
  }
  const w = data || {};
  const meta = w.winnerName ? candidateMeta[w.winnerName] : null;
  const pct = w.pct ? w.pct.toFixed(1).replace(".", ",") : null;
  const votes = w.votes ? w.votes.toLocaleString("es-CL") : null;
  const nulo = row && row["Voto nulo / blanco"] ? toIntVotes(row["Voto nulo / blanco"]).toLocaleString("es-CL") : null;
  const total = row && row["Total"] ? toIntVotes(row["Total"]).toLocaleString("es-CL") : null;

  box.innerHTML = `
    <div class="comuna-name">${name}</div>
    <div class="comuna-line">
      ${meta ? `<b>${meta.short}</b> (${w.winnerName}, ${meta.bloc})` : "Sin ganador definido"}<br>
      ${
        pct && votes
          ? `${pct}% · ${votes} votos`
          : votes
          ? `${votes} votos`
          : "Sin datos de votos"
      }<br>
      ${nulo ? `Nulo/blanco: ${nulo} votos` : ""}<br>
      ${total ? `Total: ${total} votos` : ""}
    </div>
  `;
}

// =====================
// MAPA LEAFLET
// =====================
const map = L.map("map", {
  zoomControl: true,
  attributionControl: false
});

L.tileLayer('', { attribution:'' }).addTo(map);

let geojsonLayer;
let winnersByComuna = {};   // { "Valparaíso": { winnerName, votes, pct }, ... }
let sheetRowByComuna = {};  // { "Valparaíso": rowObject }

// Estilo por comuna
function styleFeature(feature) {
  const name = feature.properties.comuna || feature.properties.Comuna || "";
  const info = winnersByComuna[name] || null;
  let fill = "#6b7280"; // gris por defecto

  if (info && info.winnerName && candidateMeta[info.winnerName]) {
    fill = candidateMeta[info.winnerName].color;
  }

  return {
    color: "#ffffff",
    weight: 1.5,
    fillColor: fill,
    fillOpacity: 0.9
  };
}

function onEachFeature(feature, layer) {
  const name = feature.properties.comuna || feature.properties.Comuna || "";
  const info = winnersByComuna[name] || null;
  const meta = info && info.winnerName ? candidateMeta[info.winnerName] : null;
  const pct = info && info.pct ? info.pct.toFixed(1).replace(".", ",") : null;

  let tooltipHtml = `<strong>${name}</strong><br>`;
  if (meta) {
    tooltipHtml += `${info.winnerName}`;
    if (pct) tooltipHtml += ` — ${pct}%`;
  } else {
    tooltipHtml += `Sin datos (demo)`;
  }

  layer.bindTooltip(tooltipHtml, { sticky:true, direction:"top" });

  layer.on({
    click: () => {
      updateComunaInfo(name, info, sheetRowByComuna[name]);
    },
    mouseover: (e) => {
      e.target.setStyle({ weight:2.5 });
    },
    mouseout: (e) => {
      geojsonLayer.resetStyle(e.target);
    }
  });
}

// =====================
// CARGA DE GOOGLE SHEETS + GEOJSON
// =====================
async function loadSheet() {
  const res = await fetch(SHEET_CSV_URL + "&t=" + Date.now(), { cache:"no-store" });
  const text = await res.text();
  const { headers, rows } = parseCSV(text);

  const candidateColumns = headers.filter(h =>
    h !== "Comuna" && h !== "Voto nulo / blanco" && h !== "Total"
  );

  winnersByComuna = {};
  sheetRowByComuna = {};

  rows.forEach(row => {
    const comunaName = (row["Comuna"] || "").trim();
    if (!comunaName) return;

    let bestName = null;
    let bestVotes = -1;
    const totalVotes = toIntVotes(row["Total"]);

    candidateColumns.forEach(col => {
      const votes = toIntVotes(row[col]);
      if (votes > bestVotes) {
        bestVotes = votes;
        bestName = col;
      }
    });

    const pct = totalVotes > 0 && bestVotes >= 0
      ? (bestVotes * 100) / totalVotes
      : null;

    winnersByComuna[comunaName] = {
      winnerName: bestName,
      votes: bestVotes >= 0 ? bestVotes : null,
      pct: pct
    };

    sheetRowByComuna[comunaName] = row;
  });
}

async function init() {
  try {
    await loadSheet();

    const res = await fetch("valparaiso_only.geojson");
    const data = await res.json();

    geojsonLayer = L.geoJSON(data, {
      style: styleFeature,
      onEachFeature
    }).addTo(map);

    map.fitBounds(geojsonLayer.getBounds(), { padding:[10,10] });
  } catch (err) {
    console.error("Error cargando datos:", err);
  }

  renderCandidateList();
  updateComunaInfo(null, null, null);
  document.getElementById("timestamp").textContent =
    "Actualizado: " + new Date().toLocaleString("es-CL", {
      dateStyle:"medium",
      timeStyle:"short"
    });
}

init();
</script>
</body>
</html>

